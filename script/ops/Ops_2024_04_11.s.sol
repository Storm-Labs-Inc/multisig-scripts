// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.18;

import { IERC20 } from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import { TimelockController } from "@openzeppelin/contracts/governance/TimelockController.sol";
import { RewardForwarder } from "cove-contracts-boosties/src/rewards/RewardForwarder.sol";
import { ERC20RewardsGauge } from "cove-contracts-boosties/src/rewards/ERC20RewardsGauge.sol";
import { CoveYearnGaugeFactory } from "cove-contracts-boosties/src/registries/CoveYearnGaugeFactory.sol";
import { CoveToken } from "cove-contracts-boosties/src/governance/CoveToken.sol";
import { console2 as console } from "forge-std/Console2.sol";
import { OpsMultisigScript } from "./OpsMultisigScript.s.sol";

contract Script is OpsMultisigScript {
    function run(bool shouldSend) public override {
        super.run(shouldSend);
        // Skip to after the timelock period
        vm.warp(1_712_977_079);

        address timelockController = deployer.getAddress("TimelockController");
        address coveToken = deployer.getAddress("CoveToken");
        address coveYfiRewardsGauge = deployer.getAddress("CoveYfiRewardsGauge");
        address coveYfiRewardsGaugeRewardForwarder = deployer.getAddress("CoveYFIRewardsGaugeRewardForwarder");
        CoveYearnGaugeFactory factory = CoveYearnGaugeFactory(deployer.getAddress("CoveYearnGaugeFactory"));
        CoveYearnGaugeFactory.GaugeInfo[] memory info = factory.getAllGaugeInfo(5, 0);

        // Start batch
        require(CoveToken(coveToken).allowedSender(coveYfiRewardsGauge) == false, "multicall already executed?");
        // https://etherscan.io/tx/0x7d43793b1a45e228c25c26fae4e18294abdba2893c595d15eea1d65f058d7df9#eventlog
        addToBatch(
            address(timelockController),
            0,
            abi.encodeCall(
                TimelockController.execute,
                (
                    coveToken,
                    0,
                    hex"AC9650D800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000004A00000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000005C00000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000006E0000000000000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000007A00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000086000000000000000000000000000000000000000000000000000000000000008C00000000000000000000000000000000000000000000000000000000000000920000000000000000000000000000000000000000000000000000000000000098000000000000000000000000000000000000000000000000000000000000009E00000000000000000000000000000000000000000000000000000000000000A400000000000000000000000000000000000000000000000000000000000000AA00000000000000000000000000000000000000000000000000000000000000B000000000000000000000000000000000000000000000000000000000000000B600000000000000000000000000000000000000000000000000000000000000BC00000000000000000000000000000000000000000000000000000000000000C200000000000000000000000000000000000000000000000000000000000000C800000000000000000000000000000000000000000000000000000000000000CE00000000000000000000000000000000000000000000000000000000000000D400000000000000000000000000000000000000000000000000000000000000DA00000000000000000000000000000000000000000000000000000000000000E000000000000000000000000000000000000000000000000000000000000000E600000000000000000000000000000000000000000000000000000000000000EC00000000000000000000000000000000000000000000000000000000000000F200000000000000000000000000000000000000000000000000000000000000F800000000000000000000000000000000000000000000000000000000000000FE0000000000000000000000000000000000000000000000000000000000000104000000000000000000000000000000000000000000000000000000000000010A00000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000048302BA7BCDF2BD59D20F8893C0F11B431A3BE24000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000003BDEF86A2E4C5C3661158017CB9BF78FD91DB9E8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000093F4FCA4B71912EDB33B2D4BB92E5B85658D833000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000AC553BDE3C4C65CAF1F5B6F9C82EC549EC1A48CA000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000FC1D8AA95A54E0C31A44FDEF5F3F3CE0B0183C32000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000B85BE494135E2B8FFB1DA00D9F02B06CF9E29E0B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000F750C238CE033AFC224C2E57D0FCB86E64DB0221000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000013B0F3BB3934539DCC8ABA18C27F6808FDA17A19000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000976A1222DE832FED3781CFBF002069DB07B48E34000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000E905B771E2E024685B933716455A4B2B787B7FC5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000B5907B7913F4DC10C5C0FC75C570C7D78D16768F000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000E4F9305D9864B24F4BC50B966F7B92C56347FE31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000009F4FC9B3E22610337F9A7FCA722679F54F0609C9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000006AAEFA0DABA6F9D53D42223EACC56912A42F394D000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000002BCC065433C608B2E71EA80405E260CA9B40FF65000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000059D7BC6260F9424E843DAFC07C6950DA6CD806A1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000037C9F4B6AA3017D04EA2C1B3D16E8FF689D725D3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000652569D171E37343602AD5DFA883A6B15EA38EF8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000F4E7FF66FD3D1C33B3020FFA575C33CB2968082D000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000008FE64E71602843CE310585E6BBE85C3452C2D5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000D503A0077E1C34997361E909B757DBD8C8BFE288000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000C2677F1270496278ED8D0453547F85D52CAAA9E9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000066AFC16E2FACF4EEA0712EDEBE0B96C5F51606FA000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000B393273BACE7C8FD0B8ED93D6692CCC7A3FD44EF000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000000506536CA91BD334D557F9575E6BEBF75499E15B000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000051797DE30F1025B0BD75BD18EE8A694920A7102C000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000090B28AA7DF2EFAAAD4582AFAF4D2A1C61519A245000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000007F43760691340CE4DDE147B2D3501D30A5E917E3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000C2BFAA32B0FB6A9CA58CFC9D22A7A28592A3EF14000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000BFB8B7B6AB58D17F2769886F3E5B31234C516DF6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000ED08B03BAEAB9EEF24F8AAA7C752F34A3264992E000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F40000000000000000000000004BE42460681FCF7ED6BB5E2C2638251F2A586017000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F400000000000000000000000006F45B88BD89E7494714F19F78F1A9BC5304F504000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024C746C8F4000000000000000000000000174153E823FBB35D60398941C74C0F44603229AA00000000000000000000000000000000000000000000000000000000",
                    bytes32(0),
                    bytes32(0)
                )
            )
        );
        require(CoveToken(coveToken).allowedSender(coveYfiRewardsGauge) == true, "multicall failed");

        // queueing up the rewards for epoch 0, week 0
        // 3.5M / 3 COVE to CoveYFIRewardsGauge
        // (1M / 5) / 3 COVE to each auto-compoiunding gauge
        addToBatch(
            coveToken,
            0,
            abi.encodeCall(IERC20.transfer, (coveYfiRewardsGaugeRewardForwarder, uint256(3_500_000 ether) / 3))
        );
        addToBatch(
            coveYfiRewardsGaugeRewardForwarder, 0, abi.encodeCall(RewardForwarder.forwardRewardToken, (coveToken))
        );
        require(CoveToken(coveToken).balanceOf(coveYfiRewardsGauge) == uint256(3_500_000 ether) / 3, "Forward failed");
        require(ERC20RewardsGauge(coveYfiRewardsGauge).getRewardData(address(coveToken)).rate > 0, "rate not set");
        for (uint256 j = 0; j < info.length; j++) {
            address autoCompoundingGaugeRewardForwarder =
                ERC20RewardsGauge(info[j].autoCompoundingGauge).getRewardData(address(coveToken)).distributor;
            console.log("Queueing up rewards for gauge", info[j].autoCompoundingGauge);
            addToBatch(
                coveToken,
                0,
                abi.encodeCall(
                    IERC20.transfer, (autoCompoundingGaugeRewardForwarder, (uint256(1_000_000 ether) / 5) / 3)
                )
            );
            addToBatch(
                autoCompoundingGaugeRewardForwarder, 0, abi.encodeCall(RewardForwarder.forwardRewardToken, (coveToken))
            );
            require(
                ERC20RewardsGauge(info[j].autoCompoundingGauge).getRewardData(address(coveToken)).rate > 0,
                "rate not set"
            );
        }

        // Execute batch
        if (shouldSend) executeBatch(true);
    }
}
